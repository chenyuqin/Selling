<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="selling.refund.record">
	<resultMap id="refundRecordVo" type="selling.sunshine.model.RefundRecord">
		<result property="refundRecordId" column="refund_id"></result>
		<result property="refundName" column="refund_name"></result>
		<result property="refundPercent" column="refund_percent"></result>
		<result property="refundAmount" column="refund_amount"></result>
		<result property="refundDescription" column="refund_description"></result>
		<association property="agent" column="agentId = agent_id" select="agentLiteQuery"></association>
		<association property="orderPool" column="orderPoolId = order_pool_id" select="orderPoolQuery"></association>
	</resultMap>
	
	  <resultMap id="agentLiteVo" type="selling.sunshine.model.lite.Agent">
        <result property="agentId" column="agent_id"></result>
        <result property="name" column="agent_name"></result>
        <result property="phone" column="agent_phone"></result>
    </resultMap>
    
    <resultMap id="goodsVo" type="selling.sunshine.model.Goods">
		<result property="goodsId" column="goods_id"></result>
		<result property="name" column="goods_name"></result>
		<result property="price" column="goods_price"></result>
		<result property="description" column="goods_description"></result>
	</resultMap>
    
    <resultMap id="orderPoolVo" type="selling.sunshine.model.OrderPool">
       <result property="orderPoolId" column="pool_id"></result>
       <result property="poolDate" column="pool_date"></result>
       <association property="goods" column="goodsId = goods_id"
			select="goodsQuery"></association>
    </resultMap>
	
    <insert id="insert" parameterType="selling.sunshine.model.RefundRecord"
		useGeneratedKeys="false">
		INSERT INTO refund_record
		<set>
		    refund_id=#{refundRecordId},
			<if test="orderPool != null and orderPool != ''">
				order_pool_id = #{orderPool.orderPoolId},
			</if>
			<if test="refundName != null and refundName != ''">
				refund_name = #{refundName},
			</if>
			<if test="refundDescription != null and refundDescription != ''">
				refund_description = #{refundDescription},
			</if>
			<if test="refundPercent != null and refundPercent != ''">
				refund_percent = #{refundPercent},
			</if>
			<if test="refundAmount != null and refundAmount != ''">
				refund_amount = #{refundAmount},
			</if>
			<if test="agent != null and agent != ''">
				agent_id = #{agent.agentId},
			</if>
			block_flag = #{blockFlag},
			create_time = #{createAt}
		</set>
    </insert>
    
   <select id="agentLiteQuery" parameterType="java.util.Map" resultMap="agentLiteVo">
		SELECT agent_id, agent_name, agent_phone
		FROM agent
		WHERE agent_id = #{agentId}
	</select>
	
	<select id="orderPoolQuery" parameterType="java.util.Map" resultMap="orderPoolVo">
		SELECT pool_id,goods_id,pool_date
		FROM order_pool
		WHERE 1 = 1 
		<if test="orderPoolId != null and orderPoolId != ''">
            AND pool_id	 = #{orderPoolId}
        </if>
        ORDER BY pool_date
	</select>
	
	
	
	<select id="query">
	    SELECT refund_id,order_pool_id,refund_name,refund_percent,refund_amount,refund_description,agent_id
	    FROM refund_record
	    WHERE 1 = 1
        <if test="refundRecordId != null and refundRecordId != ''">
            AND refund_id = #{refundRecordId}
        </if>
        <if test="agentId != null and agentId != ''">
            AND agent_id = #{agentId}
        </if>
	</select>
	
	<select id="goodsQuery" parameterType="java.util.Map" resultMap="goodsVo">
		SELECT goods_id, goods_name, goods_price, goods_description
		FROM goods
		WHERE goods_id = #{goodsId}
	</select>

	
</mapper>