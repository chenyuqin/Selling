<div class="tabbar">
<div class="weui_tab_bd">
<div class="hd">
    <h1 class="page_title">订单管理</h1>
    <p id="refund_condition" class="page_desc">更多关于订单的操作</p>
</div>
<div class="bd">
    <div class="weui_btn_area clear-margin-top">
        <a href="${path.concat('/agent/order/overview')}" class="weui_btn weui_btn_plain_primary">订单概览</a>
    </div>
    <div class="weui_tab">
        <div class="weui_navbar">
            <div class="weui_navbar_item " id="saved">
                已保存 
            </div>
            <div class="weui_navbar_item" id="submit">
                未付款
            </div>
            <div class="weui_navbar_item" id="paid">
                已付款
            </div>
            <div class="weui_navbar_item" id="closed">
                已结束
            </div>
        </div>
        <div class="weui_tab_bd">
            <div id="order_list" class="weui_cells weui_cells_access clear-margin-top">
            </div>
        </div>
    </div>
</div>
#parse("/agent/loading.vm")
</div>
#parse("/agent/component/navigate.vm")
</div>
<script>
	$(document).ready(function(){
		var url = "${path.concat('/refund/calculateRefund')}";
		$.get(url, function(result){
			console.debug(result);
			if(result.responseCode != "RESPONSE_OK"){
				return;
			}
			var data = result.data;
			var config = data[0];
			if($.isEmptyObject(config)){
				return;
			}
			var num = 0;
			for(var i = 0; i < data.length; i++){
				num += data[i]['quantity'];
			} 
			$("#refund_condition").html("社群奖励进度： " + num + "件");		
		});
		
		
		$.get_order(${type});
		switch(${type}){
		case 0:
			$("#saved").css("font-weight","bold");
            $("#saved").addClass("weui_bar_item_on");
            break;
		case 1:
			$("#submit").css("font-weight","bold");
            $("#submit").addClass("weui_bar_item_on");
            break;
		case 2:
			$("#paid").css("font-weight","bold");
            $("#paid").addClass("weui_bar_item_on");
            break;
		case 3:
			$("#closed").css("font-weight","bold");
            $("#closed").addClass("weui_bar_item_on");
            break;
		default:
		}
	});

    $(".weui_navbar_item").click(function () {
        var current = $(".weui_navbar").find(".weui_bar_item_on");
        var current_id = current.attr("id");
        var target_id = $(this).attr("id");
        if (current_id != target_id) {
            current.removeClass("weui_bar_item_on");
            current.css("font-weight","normal");
            if (target_id == "saved") {
            	$.get_order(0);
            } else if (target_id == "submit") {
				$.get_order(1);
            } else if (target_id == "paid") {
				$.get_order(2);
            } else if (target_id == "closed") {
				$.get_order(3);
            }
            $(this).css("font-weight","bold");
            $(this).addClass("weui_bar_item_on")
        }
    });
    
    //异步获取已保存
    $.get_order = function(type){
    	$("#loadingToast").show();
    	$("#order_list").empty();
    	var url = "${path.concat('/agent/order/list')}/" + type;
    	$.getJSON(url, function(data){
    		if(data.description == "您需要重新登录"){
    			window.location="${path.concat('/agent/login')}"; 
    			return;
    		}
    		var list = data.data;
    		$.each(list, function(i, val){
    			var typeString = "";
    			switch(val.type){
    			case "ORDINARY":
    				break;
    			case "GIFT":
    				typeString = "(赠送)";
    				break;
    			case "CUSTOMER":
    				typeString = "(分享)";
    				break;
    			default:
    			}
    			var	timeString = (new Date(val.createAt)).format("yyyy MM dd");
    			var time = timeString.split(" ");
    			var html = 
    				"<a class='weui_cell' id='" + val.orderId+ "'>" + 
    				"<div class='weui_cell_hd'>" + 
    				"<i class='icon icon_article'></i>" + 
    				"</div>" + 
    				"<div class='weui_cell_bd weui_cell_primary'>" +
    				"<p>" + time[0] + "年" + parseInt(time[1]) + "月" + time[2] + "日<span style='color:#888;'>" + typeString + "</span></p>" +
    				"</div>" + 
    				"<div class='weui_cell_ft'>含" + val.orderItems.length + "个订单项</div>" + 
    				"</a>" +
					"<div class='order_detail' style='display:none;'>"					    				
    			for(var j = 0; j < val.orderItems.length; j++){
    				var wuliu = "";
    				switch(val.orderItems[j].status){
    				case "NOT_PAYED":wuliu = "(未付款)";break;
    				case "PAYED":wuliu="(已付款)";break;
    				case "SHIPPED":wuliu="(已发货)";break;
    				case "RECEIVED":wuliu="(已签收)";break;
    				default:break;
    				}
    				html += 
    				"<a class='weui_cell order_item"+ val.orderId + "'>" +
    				"<div class='weui_cell_bd weui_cell_primary'>" +
    				"<p>" + val.orderItems[j].customer.name +"<span style='color:#888;'>" + wuliu + "</span></p>" + 
    				"</div>" + 
    				"<div class='weui_cell_ft'>查看详情</div>"
    				"</a>";
    			}
    			html += "</div>";
    			$("#order_list").append(html);
    			downId = 0;
    			$("#" + val.orderId).on("click",function(){
    				$("#" + val.orderId).next().slideToggle();
    				if(val.orderId != downId){
    					$("#" + downId).next().slideToggle();
    				}
    				downId = val.orderId;
    			});
    			$(".order_item" + val.orderId).on("click", function(){
    				window.location =  "${path.concat('/agent/order/detail/" + val.orderId + "')}";
    			});
    		});
    		$("#loadingToast").hide();
    	});
    }
        
    Date.prototype.format = function (format) {
    var o = {
        "M+": this.getMonth() + 1,
        // month
        "d+": this.getDate(),
        // day
        "h+": this.getHours(),
        // hour
        "m+": this.getMinutes(),
        // minute
        "s+": this.getSeconds(),
        // second
        "q+": Math.floor((this.getMonth() + 3) / 3),
        // quarter
        "S": this.getMilliseconds()
        // millisecond
    };
    if (/(y+)/.test(format) || /(Y+)/.test(format)) {
        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
        }
    }
    return format;
};
</script>