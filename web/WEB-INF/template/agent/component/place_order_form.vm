<form id="place_order_form">
<div id="place_order_panel">
    <div class="order_content">
        <div class="panel">
           <div class="hd">
                <h1 class="page_title">代客下单</h1>
            </div>
            <div class="bd">
                <div class="weui_panel">
                    <div class="weui_cells weui_cells_access clear-margin-top">
                        <a class="weui_cell" id="add_order_btn">
                            <div class="weui_cell_bd weui_cell_primary">
                                <p>添加订货单</p>
                            </div>
                            <div class="weui_cell_ft"></div>
                        </a>
                    </div>
                    <div class="list-cell" id="order_item_list">
                       <!-- 改成了动态添加 -->
                    </div>
                </div>
                <div class="weui_btn_area">
                    <a class="weui_btn weui_btn_plain_primary" id="save_order_btn">保存订单</a>
                    <a class="weui_btn weui_btn_primary" id="place_order_btn">确认下单</a>
                </div>
            </div>
        </div>
    </div>
    <div class="order_summary">
        <div class="weui_panel">
            <div class="weui_panel_bd">
                <div id="total_goods" class="weui_media_box">
                    总计:
                    <p class="weui_media_text">共计0元</p>
                </div>
            </div>
        </div>
    </div>
</div>
</form>
#parse("/agent/order/add_order_item.vm")
<script>
	//立了一个flag，判断是新增还是修改订单
	isAdd = true;
    $("#add_order_item").hide();
    $("#add_order_btn").click(function () {
    	isAdd = true;
        $("#add_order_item").fadeIn();
        $("#place_order_panel").hide();
    });
    $("#place_order_btn").click(function(){
    	if(!$.check_order()){
    		return;
    	}
    	$("#place_order_form").attr("action", "${path.concat('/agent/order/place/submit')}");
    	$("#place_order_form").attr("method","post");
    	$("#place_order_form").submit();
    });

    $("#save_order_btn").click(function(){
    	if(!$.check_order()){
    		return;
    	}
    	$("#place_order_form").attr("action", "${path.concat('/agent/order/place/save')}");
    	$("#place_order_form").attr("method","post");
    	$("#place_order_form").submit();
    });
    $.check_order = function(){
    	if($("#order_item_list").children().size() == 0) {
    		$("#dialog").find(".weui_dialog_bd").html("还没有创建订单");
    		$("#dialog").fadeIn();
    		return false;
    	}
    	return true;
    }
    
    //计算总价
    $.calculate = function(){
    	var order_info_list = new Object();
        var order_item_list = $("#order_item_list").children();
        $.each(order_item_list, function(i, val){
        	var name = $(val).children().eq(2).find(".weui_cell_ft").text();
        	var quantity = $(val).children().eq(3).find(".weui_cell_ft").text();
        	var price = $(val).children().eq(8).val();
        	if(order_info_list[name] == undefined) {
        		order_info_list[name] = new Object();
        		order_info_list[name]['quantity'] = parseInt(quantity);
        		order_info_list[name]['order_item_price'] = parseFloat(price) * quantity ;
        	} else {
        		order_info_list[name]['quantity'] += parseInt(quantity);
        		order_info_list[name]['order_item_price'] += parseFloat(price) * quantity;
        	}
        });
        $("#total_goods").empty();
        var total_price = 0;
        for(var order_info in order_info_list) {
        	total_price += order_info_list[order_info]['order_item_price'];
        	$("#total_goods").append("<p class='weui_media_text'>" 
        		+ order_info + ": " + order_info_list[order_info]['quantity'] +
 				"件, 共" + order_info_list[order_info]['order_item_price'] + "元</p>")
        }
        $("#total_goods").append(" <p class='weui_media_text'>共计" + total_price + "元</p>");
    }
    //地址美化长度
    $.addressBeautify = function(){
   		var order_item_list = $("#order_item_list").children();
    	$.each(order_item_list,function(i, val){
			var address = $(val).children().eq(1).find(".weui_cell_ft").html();
			$(val).children().eq(1).find(".weui_cell_ft").html($.utf8Substr(address,25));
		});
	}
</script>