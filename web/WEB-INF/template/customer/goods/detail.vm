#parse("/common/util.vm")
<html lang="zh_CN">
<head>
    #parse("/customer/component/init.vm")
    <link rel="stylesheet" href="${path.concat('/plugins/unslider/css/unslider.css')}"/>
    <link rel="stylesheet" href="${path.concat('/plugins/fancybox/source/jquery.fancybox.css')}" type="text/css"
          media="screen"/>
    <link rel="stylesheet" href="${path.concat('/material/css/customer/goods_detail.css')}"/>
    <script type="text/javascript" src="${path.concat('/plugins/jquery/jquery.event.move.js')}"></script>
    <script type="text/javascript" src="${path.concat('/plugins/jquery/jquery.event.swipe.js')}"></script>
    <script type="text/javascript" src="${path.concat('/plugins/fancybox/source/jquery.fancybox.pack.js')}"></script>
    <script type="text/javascript" src="${path.concat('/plugins/jquery/pinchzoom.min.js')}"></script>
    <script type="text/javascript" src="${path.concat('/plugins/jquery/jquery.cityselect.js')}"></script>
    <script type="text/javascript" src="${path.concat('/plugins/unslider/js/unslider-min.js')}"></script>
    <title>商品详情</title>
</head>
<body ontouchstart>
<div class="below">
    <div class="unslider_div">
        <div class="fading-slider">
            <ul>
                <li>
                    <a id="first_img" class="logo" href="${path.concat('/material/goods_img/1_b.jpg')}">
                        <img class="img" src="${path.concat('/material/goods_img/1.jpg')}"/>
                    </a>
                </li>
                <li>
                    <a class="logo" href="${path.concat('/material/goods_img/2.jpg')}">
                        <img class="img" src="${path.concat('/material/goods_img/2.jpg')}"/>
                    </a>
                </li>
                <li>
                    <a class="logo" href="${path.concat('/material/goods_img/3_b.jpg')}">
                        <img class="img" src="${path.concat('/material/goods_img/3.jpg')}"/>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="gap"></div>
    <div class="detail_area">
        <div class="options_div">
            <table cellpadding="0" cellspacing="0">
                <th>
                <td class="normal chosen">
                    <button id="det" class="option chosen_btn">图文详情</button>
                </td>
                <td class="normal">
                    <button id="par" class="option">产品参数</button>
                </td>
                <td class="normal">
                    <button id="mor" class="option">更多信息</button>
                </td>
                </th>
            </table>
        </div>
        <div class="gap"></div>
        <div id="detail" class="detail">
            <a id="feelings" href="${path.concat('/material/images/feelings_b.jpg')}">
                <img class="img" src="${path.concat('/material/images/feelings.jpg')}"/>
            </a>
        </div>
        <div id="parameters" class="product_parameters">
            <table class="p_table">
                <tr>
                    <td class="p_hd">产品名称</td>
                    <td class="p_bd">云草纲目三七超细粉</td>
                </tr>
                <tr>
                    <td class="p_hd">规格</td>
                    <td class="p_bd">180克/瓶</td>
                </tr>
                <tr>
                    <td class="p_hd">原料产地</td>
                    <td class="p_bd">云南文山</td>
                </tr>
                <tr>
                    <td class="p_hd">性味与归经</td>
                    <td class="p_bd">甘、微苦、温。归肝、胃经</td>
                </tr>
                <tr>
                    <td class="p_hd">用法与用量</td>
                    <td class="p_bd">3-9克，吞服一次1-3克，外用适量</td>
                </tr>
                <tr>
                    <td class="p_hd">功能与主治</td>
                    <td class="p_bd">
                        散瘀止血，消肿定痛，益气活血。用于跌扑肿痛，内外出血，气虚血瘀，胸痹心痛，中风偏瘫，气虚体弱；软组织挫伤，出血性疾病，高血压，冠心病，脑卒中，高血脂症，糖尿病血管突变，免疫功能低下见上述证候者。
                    </td>
                </tr>
                <tr>
                    <td class="p_hd">注意</td>
                    <td class="p_bd">孕妇慎用；有创面者禁用</td>
                </tr>
                <tr>
                    <td class="p_hd">生产厂家</td>
                    <td class="p_bd">昆明道地中药饮片厂</td>
                </tr>
                <tr>
                    <td class="p_hd">生产地址</td>
                    <td class="p_bd">昆明市五华区普吉路521号</td>
                </tr>
                <tr>
                    <td class="p_hd">生产许可证</td>
                    <td class="p_bd">滇20160179</td>
                </tr>
                <tr>
                    <td class="p_hd">执行标准</td>
                    <td class="p_bd">《中国药典》2015年版一部云YPBZ-0091-2008</td>
                </tr>
                <tr>
                    <td class="p_hd">监制</td>
                    <td class="p_bd">云南云草纲目生物科技有限公司</td>
                </tr>
                <tr>
                    <td class="p_hd">有效期</td>
                    <td class="p_bd">三年</td>
                </tr>
                <tr>
                    <td class="p_hd">贮藏</td>
                    <td class="p_bd">密封</td>
                </tr>
                <tr>
                    <td class="p_hd">电话</td>
                    <td class="p_bd">0871-63111137</td>
                </tr>
                <tr>
                    <td class="p_hd">邮编</td>
                    <td class="p_bd">650032</td>
                </tr>
                <tr>
                    <td class="p_hd">生产批号</td>
                    <td class="p_bd">见瓶身</td>
                </tr>
                <tr>
                    <td class="p_hd" style="border-bottom:none;">生产日期</td>
                    <td class="p_bd" style="border-bottom:none;">见瓶身</td>
                </tr>
            </table>
        </div>
        <div id="more" class="more">
        ##<a id="qrcode" href="${path.concat('/material/images/qrcode_b.png')}">
            <img class="img" src="${path.concat('/material/images/qrcode.png')}"/>
        ##</a>
            <p>长按上方二维码，扫描后关注,即可了解更多有关“云草纲目超细三七粉”的信息</p>
        </div>
    </div>
</div>
<div class="buy_area">
    <div class="footer_div">
        <div class="goods_information">
            <div class="under_div">
                <div id="agent_price" class="price">
                    <div class="pre_price">￥${goods.customerPrice}</div>
                    <div class="now_price">${goods.agentPrice}</div>
                </div>
                <div id="customer_price" class="price">
                    <div class="common_price">￥${goods.customerPrice}</div>
                </div>
                <div class="post">
                    <p>包邮</p>
                </div>
            </div>
        </div>
        <div class="num_div">
            <div class="number_area">
                <p>购买数量</p>

                <div class="number_choose">
                    <button id="min_btn" class="min">—</button>
                    <input id="goods_num" class="num_box" name="" type="text" value="1" readonly="true"/>
                    <button id="add_btn" class="add">+</button>
                </div>
            </div>
            <button id="purchase" class="btn_area">立即购买</button>
        </div>
    </div>
</div>
<div id="actionSheet_wrap">
    <div class="weui_mask_transition" id="number_div" style="display: none;"></div>
    <div class="weui_actionsheet" id="weui_actionsheet">
        <div class="weui_actionsheet_menu">
            <div class="menu_title">
                <h3>订单信息</h3>
            </div>
            <div class="address_area">
                <div class="address_information">
                    <div class="address_title">
                        <div class="address_icon">
                            <img class="icon" src="${path.concat('/material/images/address_icon.jpg')}"/>
                        </div>
                        <p>收货地址</p>
                    </div>
                    <div class="weui_cells">
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">姓名</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="customer_name" name="customerName" class="weui_input" type="text"
                                       placeholder="请填写收货人姓名"
                                       autocomplete="off"/>
                            </div>
                        </div>
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">手机号</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="customer_phone" name="phone" class="weui_input" type="tel"
                                       placeholder="请填写手机号"
                                       autocomplete="off"/>
                            </div>
                        </div>
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">地区</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <div id="province">  
                                    <select id="prov" class="prov"></select>   
                                    <select id="city" class="city" disabled="disabled" style="display:none"></select>  
                                    <select id="dist" class="dist" disabled="disabled" style="display:none"></select>  
                                </div>
                            </div>
                        </div>
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">地址</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="customer_address" name="address" class="weui_input" type="text"
                                       placeholder="请填写详细地址"
                                       autocomplete="off"/>
                            </div>
                        </div>
                        <div class="weui_cell postcode">
                            <div class="weui_cell_hd">
                                <label class="weui_label">邮政编码</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="postcode" name="postcode" class="weui_input" type="tel" placeholder="请填写邮政编码"
                                       autocomplete="off"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui_cell id">
                <div class="id_icon">
                    <img class="icon" src="${path.concat('/material/images/id_icon.jpg')}"/>
                </div>
                <div class="agent_id">
                    <table>
                        <tr>
                            <td class="hd">
                                <label class="id_label">优惠码</label>
                            </td>
                            <td class="bd">
                                #if(${agent})
                                    <input id="agent_id" class="id_input" type="text" value="${agent.agentId}"/>
                                #else
                                    <input id="agent_id" class="id_input" type="text" placeholder="可输入优惠码" value=""/>
                                #end
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <!--
            <div class="weui_cell pay">
                 <div class="weui_cell_bd weui_cell_primary">
                     <p class="pay_label">支付方式</p>
                 </div>
                 <div class="weui_cell_ft">
                     <p class="pay_way">微信支付</p>
                 </div>
            </div>
            -->
            <div class="confirm_area">
                <div class="total_info">
                    <div class="total_num">
                        <p>共

                        <p id="total_num">1</p>件
                        </p>
                    </div>
                    <div class="total_money">
                        <p class="sum">应付总额：</p>

                        <p id="total_price" class="sum_price">元</p>
                    </div>
                </div>
                <div class="to_pay">
                    <button id="confirm" class="weui_btn weui_btn_disabled weui_btn_default" disabled="disabled">支付
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="weui_dialog_alert" id="dialog" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">消息</strong></div>
        <div class="weui_dialog_bd"></div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
<div class="weui_dialog_alert" id="fail_dialog" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">网络环境较差，请重试</strong></div>
        <div class="weui_dialog_bd"></div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="${path.concat('/plugins/pingxx/pingpp_one.js')}"></script>
<script>
    var goods_price;
    var alertNum = 0;
    var forbidden = false;


    $(function () {
        var slidey = $('.fading-slider').unslider({
            animation: 'fade',
            autoplay: true,
            arrows: false,
            fluid: false
        });
        var data = slidey.data('unslider');
        $('.fading-slider').on('swipeleft', function (e) {
            data.next();
        }).on('swiperight', function (e) {
            data.prev();
        });

        //$('.img').load( function (){    //<img>加载url事件
        //    var img = new Image();    //图片预加载
        //    img.src= this.src;        //this为id="img"的dom节点对象
        //    var rate=img.height/img.width; //这里的img.width和img.height为原图大小
        //    this.height=this.width*rate;
        //});

        $('.unslider-fade').css('height', $('#first_img img').height());

        $('#detail').show();
        $('#parameters').hide();
        $('#more').hide();

        $(".logo").fancybox({
            padding: 0,
            closeBtn: false,
            closeClick: true,
            afterShow: function () {
                $('.fancybox-outter').addClass('pinch-zoom-container');
                $('.fancybox-inner').addClass('pinch-zoom');
                $('div.pinch-zoom').each(function () {
                    new RTP.PinchZoom($(this), {});
                });
                forbidden = true;
            },
            afterClose: function () {
                forbidden = false;
            }
        });

        $("#feelings").fancybox({
            padding: 0,
            closeBtn: false,
            closeClick: true,
            afterShow: function () {
                $('.fancybox-outter').addClass('pinch-zoom-container');
                $('.fancybox-inner').addClass('pinch-zoom');
                $('div.pinch-zoom').each(function () {
                    new RTP.PinchZoom($(this), {});
                });
                forbidden = true;
            },
            afterClose: function () {
                forbidden = false;
            }
        });

        $("#qrcode").fancybox({
            padding: 0,
            closeBtn: false,
            closeClick: true,
            afterShow: function () {
                $('.fancybox-outter').addClass('pinch-zoom-container');
                $('.fancybox-inner').addClass('pinch-zoom');
                $('div.pinch-zoom').each(function () {
                    new RTP.PinchZoom($(this), {});
                });
                forbidden = true;
            },
            afterClose: function () {
                forbidden = false;
            }
        });

        convert_id();

        check_agent();

        $('#agent_id').blur(function () {
            var agentId = $('#agent_id').val();
            if (agentId != "") {
                agentId = "AGT" + agentId;
                var url = '${path.concat('/agent/agentValidate/')}' + agentId;
                var param = {agentId: agentId};
                $.post(url, param, function (result) {
                    if (result.responseCode != "RESPONSE_OK") {
                        $("#dialog").find(".weui_dialog_bd").html("优惠码不存在！");
                        $("#dialog").fadeIn();
                        $("#agent_id").val("");
                    }
                    check_agent();
                });
            } else {
                check_agent();
            }
        });

        $('#customer_phone').blur(function () {
            var phone = $("#customer_phone").val();
            if (!(/^1[3|4|5|7|8]\d{9}$/.test(phone))) {
                $("#dialog").find(".weui_dialog_bd").html("手机号码有误，请重填！");
                $("#dialog").fadeIn();
                $("#customer_phone").val("");
                inactive();
            }
        });


        check_num();

        $('#province').citySelect({
            url:'${path.concat('/plugins/jquery/city.min.js')}',
            required:false,
            nodata:'none',//当子集无数据时，隐藏select
        });
        
        $('#customer_name').on('input propertychange', function () {
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });

        $('#customer_phone').on('input propertychange', function () {
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });
        
        $("#prov").change(function () {
            $("#city").empty();
            $("#dist").empty();
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });
        
        $("#city").change(function () {
            $("#dist").empty();
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });

        $("#dist").change(function () {
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });

        $('#customer_address').on('input propertychange', function () {
            if (addressInfo_validate()) {
                active();
            } else {
                inactive();
            }
        });

        document.addEventListener('pingpp_one_ready', function () {
            $('#confirm').click(function () {
                var agentId = $('#agent_id').val();
                if (agentId != "") {
                    agentId = "AGT" + agentId;
                    var url = '${path.concat('/agent/agentValidate/')}' + agentId;
                    var param = {agentId: agentId};
                    $.post(url, param, function (result) {
                        if (result.responseCode != "RESPONSE_OK") {
                            $("#dialog").find(".weui_dialog_bd").html("优惠码不存在！");
                            $("#dialog").fadeIn();
                            $("#agent_id").val("");
                            check_agent();
                        } else {
                            pay();
                        }

                    });
                } else {
                    check_agent();
                    pay();
                }
            });
        });
    });


    $('#purchase').click(function () {
        forbidden = true;
        $.toggleNumModifySheet();
    });

    $.toggleNumModifySheet = function () {
        var number_div = $('#number_div');
        var weuiActionsheet = $('#weui_actionsheet');
        weuiActionsheet.addClass('weui_actionsheet_toggle');
        number_div.show()
                .focus()
                .addClass('weui_fade_toggle').one('click', function () {
                    forbidden = false;
                    hideActionSheet(weuiActionsheet, number_div);
                });
        number_div.unbind('transitionend').unbind('webkitTransitionEnd');

        function hideActionSheet(weuiActionsheet, number_div) {
            weuiActionsheet.removeClass('weui_actionsheet_toggle');
            number_div.removeClass('weui_fade_toggle');
            number_div.on('transitionend', function () {
                number_div.hide();
            }).on('webkitTransitionEnd', function () {
                number_div.hide();
            })
        }
    }

    $('#min_btn').click(function () {
        var num = $('#goods_num').val();
        num--;
        $('#goods_num').attr('value', num);
        check_num();
        $('#total_num').text(num);
        $('#total_price').text(num * goods_price + '元');
    });

    $('#add_btn').click(function () {
        var num = $('#goods_num').val();
        num++;
        $('#goods_num').attr('value', num);
        check_num();
        $('#total_num').text(num);
        $('#total_price').text(num * goods_price + '元');
    });

    $("#dialog").find(".weui_btn_dialog.primary").click(function () {
        $("#dialog").hide();
    });

    $("#fail_dialog").find(".weui_btn_dialog.primary").click(function () {
        $("#fail_dialog").hide();
    });

    $('#det').click(function () {
        $(this).parent().addClass("chosen");
        $('#par').parent().removeClass("chosen");
        $('#mor').parent().removeClass("chosen");
        $(this).addClass("chosen_btn");
        $('#par').removeClass("chosen_btn");
        $('#mor').removeClass("chosen_btn");
        $('#detail').show();
        $('#parameters').hide();
        $('#more').hide();
    });

    $('#par').click(function () {
        $(this).parent().addClass("chosen");
        $('#det').parent().removeClass("chosen");
        $('#mor').parent().removeClass("chosen");
        $(this).addClass("chosen_btn");
        $('#det').removeClass("chosen_btn");
        $('#mor').removeClass("chosen_btn");
        $('#parameters').show();
        $('#detail').hide();
        $('#more').hide();
    });

    $('#mor').click(function () {
        $(this).parent().addClass("chosen");
        $('#par').parent().removeClass("chosen");
        $('#det').parent().removeClass("chosen");
        $(this).addClass("chosen_btn");
        $('#par').removeClass("chosen_btn");
        $('#det').removeClass("chosen_btn");
        $('#more').show();
        $('#parameters').hide();
        $('#detail').hide();
    });


    function convert_id() {
        var id = $('#agent_id').val();
        if (id != "") {
            var newId = id.slice(3);
            $('#agent_id').val(newId);
        }
    }

    function check_agent() {
        var agent = $('#agent_id').val();
        var num = $('#goods_num').val();
        if (agent) {
            $('#agent_price').show();
            $('#customer_price').hide();
            goods_price = "${goods.agentPrice}";
        } else {
            $('#customer_price').show();
            $('#agent_price').hide();
            goods_price = "${goods.customerPrice}";
        }
        $('#goods_per_price').text(goods_price + '元');
        $('#total_price').text(num * goods_price + '元');
    }

    function check_num() {
        var goodsNum = $('#goods_num').val();
        if (goodsNum == 1) {
            $('#min_btn').attr("disabled", "disabled");
            $('#min_btn').addClass("btn_disabled");
        } else {
            $('#min_btn').removeAttr("disabled");
            $('#min_btn').removeClass("btn_disabled");
        }
    }

    function addressInfo_validate() {
        var name = $('#customer_name').val();
        var phone = $('#customer_phone').val();
        var address = $('#customer_address').val();
        var area;
        if($("#prov").val()=="北京"||$("#prov").val()=="天津"||$("#prov").val()=="上海"||$("#prov").val()=="重庆"||$("#prov").val()=="香港"||$("#prov").val()=="澳门"||$("#prov").val()=="台湾"){
            area=$("#city").val();
        }else{
            if($("#prov").val()=="国外"){
                area=$("#prov").val();
            }else{
                area=$("#dist").val();
            }
        }
        if (not_null(name) && not_null(phone) && not_null(address) && not_null(area)) {
            return true;
        } else {
            return false;
        }
    }

    function active() {
        $("#confirm").removeAttr("disabled");
        $("#confirm").removeClass("weui_btn_disabled");
        $("#confirm").removeClass("weui_btn_default");
        $("#confirm").addClass("weui_btn_primary");
    }

    function inactive() {
        $("#confirm").attr("disabled", "disabled");
        $("#confirm").removeClass("weui_btn_primary");
        $("#confirm").addClass("weui_btn_disabled");
        $("#confirm").addClass("weui_btn_default");
    }

    function not_null(item) {
        if (item == null || item == "" || item.length <= 0) {
            return false;
        }
        return true;
    }

    function pay() {
        var openId = '${wechat}';
        var url = '${path.concat('/customer/place')}';
        var goodsId = "${goods.goodsId}";
        var agentId = "AGT" + $('#agent_id').val();
        var goodsNum = $('#goods_num').val();
        var customerName = $('#customer_name').val();
        var phone = $('#customer_phone').val();
        var address;
        if($("#dist").is(":hidden")){
            if($("#city").is(":hidden")){
                address = $("#prov").val() + $("#customer_address").val();
            }else{
                address = $("#prov").val() + $("#city").val() + $("#customer_address").val();
            }
        }else{
            address = $("#prov").val() + $("#city").val() + $("#dist").val() + $("#customer_address").val();
        }
        var param = {
            goodsId: goodsId,
            agentId: agentId,
            goodsNum: goodsNum,
            customerName: customerName,
            phone: phone,
            address: address,
            wechat: openId
        };
        $.post(url, param, function (result) {
            if (result.responseCode == "RESPONSE_OK") {
                var data = result.data;
                pingpp_one.init({
                    app_id: "app_K4evXLKq50O8CuL8",
                    amount: data.totalPrice,
                    channel: ['wx_pub'],
                    charge_url: "${path.concat('/order/customerpay')}",
                    charge_param: {order_id: data.orderId},
                    open_id: '${wechat}',
                    debug: false
                }, function (result) {
                    //debug 模式下获取 charge_url 的返回结果
                    if (result.debug && result.chargeUrlOutput) {
                        console.log(result.chargeUrlOutput);
                    }
                    if (!result.status) {
                        //处理错误
                        $("#fail_dialog").show();
                    }
                    else {
                        //debug 模式下调用 charge_url 后会暂停，可以调用 pingpp_one.resume 方法继续执行
                        if (result.debug && !result.wxSuccess) {
                            if (confirm('当前为 debug 模式，是否继续支付？')) {
                                pingpp_one.resume();
                            }
                        }
                        //若微信公众号渠道需要使用壹收款的支付成功页面，则在这里进行成功回调，
                        //调用 pingpp_one.success 方法，你也可以自己定义回调函数
                        //其他渠道的处理方法请见第 2 节
                        else {
                            $('.unslider-fade').hide();
                            $('.unslider-nav').hide();
                            $('.weui_actionsheet').hide();
                            $('.weui_mask_transition').hide();
                            pingpp_one.success(function (result) {
                                if (!result.status) {
                                    $("#fail_dialog").show();
                                }
                            }, function () {
                                //这里处理支付成功页面点击“继续购物”按钮触发的方法，
                                //例如：若你需要点击“继续购物”按钮跳转到你的购买页，
                                //则在该方法内写入 window.location.href = "你的购买页面 url"
                                window.location.href = "/commodity/customerorder?" + "orderId=" + data.orderId;
                            });
                        }
                    }
                });
            } else {

            }
        });
    }


    document.addEventListener("touchmove", function (e) {
        if (forbidden) {
            e.preventDefault();
            e.stopPropagation();
        }
    }, false);


</script>
</html>